---
layout: post
title: Javascript는 어떻게 동작할까? (2부)
categories: [Javascript]
tags: []
fullview: false
comments: true
---

### Intro
[1부](https://4kimball.github.io/javascript/2022/03/21/Javascript%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8F%99%EC%9E%91%ED%95%A0%EA%B9%8C-(1%EB%B6%80).html)에서는 런타임 환경에서 자바스크립트 코드가 어떻게 실행될 수 있는지 알아봤습니다.
2부에서는 자바스크립트 코드가 `V8`엔진에 의해 어떻게 해석되고 실행될 수 있는지 자세히 알아보려고 합니다. 해당 내용을 공부하면서 용어 또는 개념에 대한 정확한 이해가 필수적이었습니다. 따라서 V8엔진이 실행되는 전체적인 과정을 대략 설명하고 각 과정을 자세히 정리하려고 합니다.
이 과정에서 개인적으로 중요하다고 생각하는 개념에 대한 설명도 함께 정리하였습니다. 

2부에서 V8엔진을 이해한다면 각자가 생각하는 "좋은 코드"에 더 가까이 다가갈 수 있지 않을까 생각합니다. 예를 들어, 객체의 프로퍼티를 업데이트할 때 프로퍼티의 순서를 처음과 다르게 하면 안되는 이유를 이해하고 본인이 코드를 작성할 때 유의하면서 작성할 수 있을 것입니다.

---

### V8 엔진은 무엇일까?
먼저 V8엔진이 무엇인지 알아야합니다. V8은 구글이 웹 브라우저에서 자바스크립트의 수행 속도를 개선하기 위해 C++로 개발한 웹 어셈블리 엔진입니다. 현재 Chrome과 Node.js에서 사용되고 있습니다. 
우리가 자바스크립트와 같은 고급 언어로 작성된 코드는 컴퓨터가 이해할 수 없기 때문에 컴퓨터가 이해할 수 있는 언어로 변환을 해줘야합니다. 이때, V8은 자바스크립트 코드를 가상머신이 이해할 수 있는 `바이트 코드`로 변환해줍니다. (아래에서 바이트 코드에 대해 좀 더 자세하게 정리하였습니다.)

---

### V8이 자바스크립트 코드를 해석하는 과정
먼저 V8엔진이 자바스크립트 코드를 어떻게 해석하는 간략하게 알아보겠습니다. 다음은 해석 과정을 순차적으로 나열한 것입니다.
1. 파서를 통해 자바스크립트 코드를 파싱하여 `추상 구문 트리(Abstract Syntax Tree)`로 변환합니다.
2. 인터프리터인 `이그니션`이 AST를 통해 `바이트 코드`로 변환시킵니다.
3. 자주 사용되는 코드를 `터보팬`으로 보내 최적화된 코드로 컴파일합니다.

이제는 각각의 단계를 자세하게 알아보도록 하겠습니다.

---

### 파싱
파싱을 통해 `추상 구문 트리`가 도출되며 추상 구문 트리는 컴퓨터가 해석하기 쉽게 구조화된 자료구조입니다. 파싱하여 추상 구문 트리를 만들게되면 바이트 코드로 쉽게 변환할 수 있는 준비를 할 수 있게됩니다. 또한 트리를 생성하면서 불필요한 구문은 생략하게 됩니다.

---

### 이그니션
이그니션은 추상 구문 트리를 통해 바이트 코드로 변환하는 인터프리터입니다. v5.9이전에는 이그니션이 아닌 `풀코드젠`을 통해 바이트코드로 변환했습니다.
풀코드젠은 한 번에 전체 소스코드를 컴파일했습니다. 하지만 자바스크립트는 동적으로 타입을 결정하는 언어이기 때문에 코드가 실행되기 전에 알 수 없는 것들이 많았으며 컴파일할 때 메모리 점유율이 높다는 단점을 갖고 잇었습니다.

따라서 이를 대체하기 위해 이그니션이라는 인터프리터가 나오게 되었습니다. 이그니션은 한 줄씩 실행될 때마다 컴파일을 진행하여 풀코드젠의 문제점을 해결하였습니다.
먼저 풀코드젠으로 컴파일하여 기계어로 해석하는 것보다 이그니션을 통해 바이트 코드를 얻는 것이 메모리 사용량을 감소시킬 수 있었으며, Optimizing이나 Deoptimizing을 할 때 바이트 코드만을 사용하면 되기 때문에 효율적입니다.

> **바이트 코드?**
> 바이트 코드는 가상머신에서 코드를 실행시키기 위한 이진 표현법이다. 바이트 코드는 CPU내의 레지스터, 누산기가 어떻게 동작하라고 명령하기때문에 컴퓨터가 이해하기 쉽다.
> 특정 하드웨어 플랫폼에 종속적인 기계어와 달리 바이트코드는 가상머신에서 실행시키기때문에 플랫폼에 대한 독립성을 확보하고 다른 플랫폼에서 쉽게 사용할 수 있는 이식성을 갖고있습니다.
> 또한 자바스크립트 코드뿐만 아니라 바이트코드도 캐싱하여 두 번째로 페이지를 로드할 때는 파싱에 걸리는 시간을 줄일 수 있다.

---

### 터보팬
바이트코드가 실행되면서 자주 쓰이는 코드는 터보팬으로 보내 최적화된 코드로 다시 컴파일합니다. 런타임 중에 함수나 변수의 빈도 수에 대한 데이터를 모아서 전달해주면 터보팬은 특정 기준에 맞는 것을 찾아 최적화를 진행합니다.
이렇게 최적화를 하게되는 코드는 `자주 호출되고 변하지 않는 코드`를 최적화합니다. 반복문 내에서 같은 작업을 수행하는 로직이 이러한 기준에 해당될 수 있습니다. 터보팬에서 사용되는 최적화 기법에는 `히든 클래스`와 `인라인캐싱`이 있습니다. (아래에서 더 자세히 알아보겠습니다.) 

터보팬에서 최적화를 진행한 후에 실행되기 전에 여전히 같은 코드인지 검사를 진행합니다. 이때 같은 코드가 아닐 때는 Deoptimizing을 합니다. 그렇기 때문에 동적으로 프로퍼티를 추가하거나 삭제하는 것은 오버헤드를 발생시켜 비효율적입니다. (대부분의 브라우저에서는 Optimizing과 Deoptimizing의 싸이클이 n번 이상 지속될 경우 최적화를 하지 않습니다.)

---

### 히든 클래스
터보팬에서 사용하는 최적화기법 중의 하나로 먼저 히든 클래스를 알아보겠습니다.

--
